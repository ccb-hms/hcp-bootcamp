<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>HCP Intro to R Bootcamp - Modeling and Testing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.29/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">HCP Intro to R Bootcamp</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../notebooks/sessions.html" rel="" target="" aria-current="page">
 <span class="menu-text">Session Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resources/resources.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/session3.html">Modeling and Testing</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/sessions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sessions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/session1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R Basics and Reproducibility Tools</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/session2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Summarizing and Visualizing data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/session3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Modeling and Testing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/session4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data wrangling I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/session5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Wrangling II and Other Analysis Skills</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a></li>
  <li><a href="#distributions-in-r" id="toc-distributions-in-r" class="nav-link" data-scroll-target="#distributions-in-r">Distributions in R</a></li>
  <li><a href="#performing-simple-tests" id="toc-performing-simple-tests" class="nav-link" data-scroll-target="#performing-simple-tests">Performing simple tests</a></li>
  <li><a href="#regression" id="toc-regression" class="nav-link" data-scroll-target="#regression">Regression</a>
  <ul class="collapse">
  <li><a href="#example-analysis---infant-mortality" id="toc-example-analysis---infant-mortality" class="nav-link" data-scroll-target="#example-analysis---infant-mortality">Example Analysis - Infant Mortality</a>
  <ul class="collapse">
  <li><a href="#residual-plots" id="toc-residual-plots" class="nav-link" data-scroll-target="#residual-plots">Residual Plots</a></li>
  </ul></li>
  <li><a href="#confidence-and-prediction-intervals" id="toc-confidence-and-prediction-intervals" class="nav-link" data-scroll-target="#confidence-and-prediction-intervals">Confidence and Prediction intervals</a></li>
  <li><a href="#regressions-using-factors" id="toc-regressions-using-factors" class="nav-link" data-scroll-target="#regressions-using-factors">Regressions using factors</a>
  <ul class="collapse">
  <li><a href="#fitting-factors-in-regression-models" id="toc-fitting-factors-in-regression-models" class="nav-link" data-scroll-target="#fitting-factors-in-regression-models">Fitting factors in regression models</a></li>
  </ul></li>
  <li><a href="#example-analysis---spline-regression-with-nhanes" id="toc-example-analysis---spline-regression-with-nhanes" class="nav-link" data-scroll-target="#example-analysis---spline-regression-with-nhanes">Example Analysis - Spline Regression with NHANES</a>
  <ul class="collapse">
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data">Load the data</a></li>
  <li><a href="#spline-models" id="toc-spline-models" class="nav-link" data-scroll-target="#spline-models">Spline Models</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#analyzing-survey-data" id="toc-analyzing-survey-data" class="nav-link" data-scroll-target="#analyzing-survey-data">Analyzing Survey Data</a></li>
  <li><a href="#data-1" id="toc-data-1" class="nav-link" data-scroll-target="#data-1">Data</a></li>
  <li><a href="#preparing-survey-analysis" id="toc-preparing-survey-analysis" class="nav-link" data-scroll-target="#preparing-survey-analysis">Preparing Survey Analysis</a>
  <ul class="collapse">
  <li><a href="#removing-na-weights" id="toc-removing-na-weights" class="nav-link" data-scroll-target="#removing-na-weights">Removing NA weights</a></li>
  <li><a href="#creating-combined-survey-weights" id="toc-creating-combined-survey-weights" class="nav-link" data-scroll-target="#creating-combined-survey-weights">Creating combined survey weights</a></li>
  <li><a href="#creating-the-survey-design-object" id="toc-creating-the-survey-design-object" class="nav-link" data-scroll-target="#creating-the-survey-design-object">Creating the survey design object</a></li>
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression">Logistic Regression</a></li>
  </ul></li>
  <li><a href="#exploring-packages" id="toc-exploring-packages" class="nav-link" data-scroll-target="#exploring-packages">Exploring packages</a>
  <ul class="collapse">
  <li><a href="#predictive-modeling-with-tidymodels" id="toc-predictive-modeling-with-tidymodels" class="nav-link" data-scroll-target="#predictive-modeling-with-tidymodels">Predictive Modeling with TidyModels</a></li>
  <li><a href="#bayesian-statistics-with-stan-and-brms" id="toc-bayesian-statistics-with-stan-and-brms" class="nav-link" data-scroll-target="#bayesian-statistics-with-stan-and-brms">Bayesian Statistics with Stan and brms</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Modeling and Testing</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="data" class="level1">
<h1>Data</h1>
<p>We import the dataset of cases from a simulated Ebola epidemic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/linelist_cleaned.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="distributions-in-r" class="level1">
<h1>Distributions in R</h1>
<p>Every probability distribution in R has four functions, with a root distribution name and a single letter prefix:</p>
<ul>
<li>p for “probability”, the cumulative distribution function (c.&nbsp;d.&nbsp;f.)</li>
<li>q for “quantile”, the inverse c.&nbsp;d.&nbsp;f.</li>
<li>d for “density”, the density function (p.&nbsp;f.&nbsp;or p.&nbsp;d.&nbsp;f.)</li>
<li>r for “random”, a random variable having the specified distribution</li>
</ul>
<p>For instance, for the binomial distribution we have</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Probability of seeing at most 5 successes</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">pbinom</span>(<span class="dv">5</span>, <span class="at">size=</span>n, <span class="at">prob=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.952651</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the 50th percentile of successes</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qbinom</span>(<span class="fl">0.5</span>, <span class="at">size=</span>n, <span class="at">prob=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The probability of seeing exactly 5 successes</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbinom</span>(<span class="dv">5</span>, <span class="at">size=</span>n, <span class="at">prob=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1029193</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 40 random samples from this binomial distribution</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rbinom</span>(<span class="dv">40</span>, <span class="at">size=</span>n, <span class="at">prob=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 3 2 3 4 1 2 2 2 3 3 4 3 1 3 2 3 1 2 3 4 5 3 4 2 3 4 4 2 4 2 3 1 2 5 3 4 4 6
[39] 4 3</code></pre>
</div>
</div>
</section>
<section id="performing-simple-tests" class="level1">
<h1>Performing simple tests</h1>
<p>R has built-in functionality to perform common statistical tests. The functions take the form of <code>NAME.test</code>, such as <code>t.test</code>, <code>shapiro.test</code>, <code>binomial.test</code>, <code>wilcox.test</code>, etc.</p>
<p>Lets run a t-test:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(age_years <span class="sc">~</span> gender, <span class="at">data =</span> linelist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  age_years by gender
t = -21.344, df = 4902.3, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group f and group m is not equal to 0
95 percent confidence interval:
 -7.571920 -6.297975
sample estimates:
mean in group f mean in group m 
       12.60207        19.53701 </code></pre>
</div>
</div>
<p>The formula syntax <code>age_years ~ gender</code> is used across different models and statistical methods in R. For a t-test, we want to put the numeric column on the left side of the equation and the categorical column on the right side.</p>
<p><code>t.test</code> also has optional arguments to specify variations, such as if a test is paired or if the alternative hypothesis is single sided. We can perform a single-sample t-test against a specific value by using the argument <code>mu</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(linelist<span class="sc">$</span>age_years, <span class="at">mu =</span> <span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    One Sample t-test

data:  linelist$age_years
t = -54.114, df = 5801, p-value &lt; 2.2e-16
alternative hypothesis: true mean is not equal to 25
95 percent confidence interval:
 15.69293 16.34369
sample estimates:
mean of x 
 16.01831 </code></pre>
</div>
</div>
<p>The results of a test can be stored to get individual values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(age_years <span class="sc">~</span> gender, <span class="at">data =</span> linelist)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "statistic"   "parameter"   "p.value"     "conf.int"    "estimate"   
 [6] "null.value"  "stderr"      "alternative" "method"      "data.name"  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>result<span class="sc">$</span>p.value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9.894302e-97</code></pre>
</div>
</div>
</section>
<section id="regression" class="level1">
<h1>Regression</h1>
<section id="example-analysis---infant-mortality" class="level2">
<h2 data-anchor-id="example-analysis---infant-mortality">Example Analysis - Infant Mortality</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.3     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.3     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>infdeath <span class="ot">=</span> <span class="fu">read.table</span>( <span class="st">"../data/infdeath.txt"</span>, <span class="at">head=</span><span class="cn">TRUE</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(infdeath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20  4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(infdeath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "country" "safe"    "breast"  "death"  </code></pre>
</div>
</div>
<p>We have 20 measurements on - <code>safe</code>=access to safe water - <code>breast</code>= percentage of mothers breast feeding at 6 months - <code>death</code> = infant death rate</p>
<p>When performing any time of analysis where we look at the relationship between two variables, we need to be careful to not mix up correlation and causation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(infdeath<span class="sc">$</span>breast, infdeath<span class="sc">$</span>death, <span class="at">xlab=</span><span class="st">"% Breast Feeding"</span>, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Infant Death Rate"</span>, <span class="at">pty=</span><span class="st">"s"</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex.axis=</span><span class="fl">1.5</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="session3_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looking at this data naively, it suggests that longer time breast feeding leads to greater infant mortality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(infdeath<span class="sc">$</span>safe, infdeath<span class="sc">$</span>breast, <span class="at">ylab=</span><span class="st">"% Breast Feeding"</span>, </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"% Access to safe water"</span>, <span class="at">pty=</span><span class="st">"s"</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex.axis=</span><span class="fl">1.5</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="session3_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>However, there is a <strong>latent variable</strong> which is actually influencing our result. Countries with access to safe water breast feed for less time.</p>
<p>Often, as in the example above, there is a third variable (access to clean water) that affects both the response and the predictor. To truly get at causation we typically need a randomized controlled experiment However, we cannot always do experiments, e.g.&nbsp;most epidemiology.</p>
<p>We can use the <code>lm</code> function in R to create a linear model. We then also use R’s formula notation to tell it what we want the model to describe. Here, we want to examine the relationship between mortality and breastfeeding, which we can specify by giving R the linear model <code>y~x</code>, or here <code>infdeath$death ~ infdeath$breast</code>. Note that we don’t need to tell R that we want the model to have an intercept, it incorporates one automatically.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(infdeath<span class="sc">$</span>breast, infdeath<span class="sc">$</span>death, <span class="at">xlab=</span><span class="st">"% Breast Feeding"</span>, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Infant Death Rate"</span>, <span class="at">pty=</span><span class="st">"s"</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex.axis=</span><span class="fl">1.5</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.5</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">150</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">=</span> <span class="fu">lm</span>(infdeath<span class="sc">$</span>death<span class="sc">~</span>infdeath<span class="sc">$</span>breast)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(lm1, <span class="at">col=</span><span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="session3_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can directly output the model coefficients and other information, here the learned slope and intercept of the line, by using <code>summary</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = infdeath$death ~ infdeath$breast)

Residuals:
    Min      1Q  Median      3Q     Max 
-37.568 -21.047   1.368  19.479  33.705 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      -26.978     20.148  -1.339 0.205392    
infdeath$breast    1.467      0.288   5.093 0.000265 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 23.86 on 12 degrees of freedom
  (6 observations deleted due to missingness)
Multiple R-squared:  0.6837,    Adjusted R-squared:  0.6573 
F-statistic: 25.94 on 1 and 12 DF,  p-value: 0.000265</code></pre>
</div>
</div>
<p>We can see that the intercept is about -27 and the slope is about 1.5.</p>
<section id="residual-plots" class="level3">
<h3 data-anchor-id="residual-plots">Residual Plots</h3>
<p>We can plot the residuals (<span class="math inline">\(y\)</span>-axis) against any covariates (<span class="math inline">\(x\)</span>’s) and the predicted values (<span class="math inline">\(\hat{y}\)</span>’s). We want to look for trends, such as increasing or decreasing variability (fans), and outliers. When data are collected over time, we sometimes look for relationships between successive residuals.</p>
<p>Let’s return to our child birth example and make a residual plot.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="session3_files/figure-html/residplots-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="confidence-and-prediction-intervals" class="level2">
<h2 data-anchor-id="confidence-and-prediction-intervals">Confidence and Prediction intervals</h2>
<p>There are two kinds of predictions that are interesting:</p>
<pre><code>-   *Confidence interval*: predict the mean response for a given value of $x$
-   *Prediction interval*: predict the value of the response $y$ for an individual whose covariate is $x$</code></pre>
<p>Almost all regression methods in R have prediction methods associated with them. Confidence intervals have less variability than prediction intervals.</p>
<p>Returning to our example on infant death</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">=</span> <span class="fu">lm</span>(death<span class="sc">~</span>breast, <span class="at">data=</span>infdeath)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = death ~ breast, data = infdeath)

Residuals:
    Min      1Q  Median      3Q     Max 
-37.568 -21.047   1.368  19.479  33.705 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  -26.978     20.148  -1.339 0.205392    
breast         1.467      0.288   5.093 0.000265 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 23.86 on 12 degrees of freedom
  (6 observations deleted due to missingness)
Multiple R-squared:  0.6837,    Adjusted R-squared:  0.6573 
F-statistic: 25.94 on 1 and 12 DF,  p-value: 0.000265</code></pre>
</div>
</div>
<p>We can predict the mean response for country where 62% of the women breast feed at 6 months using the `predict1 function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(lm1, <span class="at">newdata=</span><span class="fu">list</span>(<span class="at">breast=</span><span class="dv">62</span>), <span class="at">interval=</span><span class="st">"confidence"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       fit     lwr      upr
1 63.96593 49.8048 78.12705</code></pre>
</div>
</div>
<p>Or we can predict the response for a specific country where 62% of the women breast feed at 6 months</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(lm1, <span class="at">newdata=</span><span class="fu">list</span>(<span class="at">breast=</span><span class="dv">62</span>), <span class="at">interval=</span><span class="st">"prediction"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       fit      lwr      upr
1 63.96593 10.08279 117.8491</code></pre>
</div>
</div>
<p>Note how the lower and upper bounds are much tighter for the confidence interval than for the prediction interval.</p>
</section>
<section id="regressions-using-factors" class="level2">
<h2 data-anchor-id="regressions-using-factors">Regressions using factors</h2>
<p>As we’ve seen, a <em>factor</em> is a variable that takes on a discrete set of different values. These values can be unordered (e.g.&nbsp;Male/Female or European, Asian, African, etc.) or they can be ordered (age: less than 18, 18-40, more than 40). In regression models, we typically implement factors using <em>dummy variables</em>.</p>
<section id="fitting-factors-in-regression-models" class="level3">
<h3 data-anchor-id="fitting-factors-in-regression-models">Fitting factors in regression models</h3>
<p>Suppose we have a factor with <span class="math inline">\(K\)</span> levels We can fit factors in two ways</p>
<pre><code>-   **M1:** includes an intercept in the model and then use $K-1$ indicator variables
-   **M2L=:** no intercept and use $K$ indicator variables.</code></pre>
<p>In <strong>M1</strong> the intercept is the mean value of <span class="math inline">\(y\)</span>, and each <span class="math inline">\(\beta_j\)</span> is the difference in mean for the <span class="math inline">\(j^{th}\)</span> retained factor level from the overall mean. In <strong>M2</strong> each of the <span class="math inline">\(\beta_j\)</span> is the mean value for <span class="math inline">\(y\)</span> only within factor level <span class="math inline">\(j\)</span>.</p>
<p>To show an example, suppose our factor is sex, which has two levels, M and F. Our models could be</p>
<p><span class="math display">\[
  M1:  Y = \beta_0 + \beta_M \cdot 1_{M} + \epsilon \\
  E[Y | F]= \beta_0 \quad \mbox{and} \quad E[Y|M] = \beta_0 + \beta_M
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>heights <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">40</span>, <span class="at">min=</span><span class="dv">60</span>, <span class="at">max=</span><span class="dv">75</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>sex <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"M"</span>,<span class="st">"F"</span>), <span class="dv">40</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">=</span> <span class="fu">lm</span>(heights <span class="sc">~</span> sex)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = heights ~ sex)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.8438 -2.9168 -0.0762  1.8674  9.0004 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   65.419      0.923  70.877   &lt;2e-16 ***
sexM           0.903      1.245   0.726    0.473    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.916 on 38 degrees of freedom
Multiple R-squared:  0.01366,   Adjusted R-squared:  -0.01229 
F-statistic: 0.5265 on 1 and 38 DF,  p-value: 0.4725</code></pre>
</div>
</div>
<p>Or</p>
<p><span class="math display">\[
  M2: y = \beta_M \cdot 1_{M} + \beta_{F} \cdot 1_{F} + \epsilon \\
  E[Y|F] = \beta_F \quad \mbox{and} E[Y|M] = \beta_M
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding -1 tells R that we don't want an intercept</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">=</span> <span class="fu">lm</span>(heights <span class="sc">~</span> sex <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = heights ~ sex - 1)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.8438 -2.9168 -0.0762  1.8674  9.0004 

Coefficients:
     Estimate Std. Error t value Pr(&gt;|t|)    
sexF  65.4191     0.9230   70.88   &lt;2e-16 ***
sexM  66.3222     0.8349   79.44   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.916 on 38 degrees of freedom
Multiple R-squared:  0.9967,    Adjusted R-squared:  0.9965 
F-statistic:  5667 on 2 and 38 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Note that there are some issues you have to worry about when fitting a model without an intercept. With model M1 that has an intercept then for each group the test for <span class="math inline">\(H_0: \beta_j = 0\)</span> tests whether that group mean is different from the mean for the group that was used to determine the intercept. However, in M2 the test for each group, <span class="math inline">\(H_0: \beta_j = 0\)</span> is then comparing the mean for that group to zero (0). In M2, multiple-<span class="math inline">\(R^2\)</span> does not have a reasonable interpretation, and we get a very high value.</p>
</section>
</section>
<section id="example-analysis---spline-regression-with-nhanes" class="level2">
<h2 data-anchor-id="example-analysis---spline-regression-with-nhanes">Example Analysis - Spline Regression with NHANES</h2>
<section id="load-the-data" class="level3">
<h3 data-anchor-id="load-the-data">Load the data</h3>
<p>There are 6063 observations, some are incomplete and have missing values for some covariates. There are 22 covariates, which have cryptic names and you need to use the meta-data to resolve them. The survey is very complex and typically any analysis requires a substantial amount of reading of the documentation. Here we will guide you past some of the hurdles.</p>
<p>We load up the data and the metadata. In the metadata we have a textual description of the phenotype, the short name, and the target. The target tells us which of the sampled individuals was eligible to answer the question.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>nhanesDataPath <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/nhanes_spline/d4.rda"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/nhanes_spline/metaD.rda"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(metaD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-a178fabf033e133e5c62" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a178fabf033e133e5c62">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],["RIDAGEYR","RIAGENDR","RIDRETH1","DMDEDUC2","WTINT2YR","SDMVPSU","SDMVSTRA","INDFMPIR","BPQ050A","BPQ020","BPQ080","BPQ100D","LBDHDD","LBXGH","DIQ010","DIQ050","DIQ070","DIQ160","BMXBMI","LBXTC"],["Age in years at screening","Gender","Race/Hispanic origin","Education level - Adults 20+","Full sample 2 year interview weight","Masked variance pseudo-PSU","Masked variance pseudo-stratum","Ratio of family income to poverty","Now taking prescribed medicine for HBP","Ever told you had high blood pressure","Doctor told you - high cholesterol level","Now taking prescribed medicine","Direct HDL-Cholesterol (mg/dL)","Glycohemoglobin (%)","Doctor told you have diabetes","Taking insulin now","Take diabetic pills to lower blood sugar","Ever told you have prediabetes","Body Mass Index (kg/m**2)","Total Cholesterol (mg/dL)"],["Age in years of the participant at the time of screening. Individuals 80 and over are topcoded at 80 years of age.","Gender of the participant.","Recode of reported race and Hispanic origin information","What is the highest grade or level of school {you have/SP has} completed or the highest degree {you have/s/he has} received?","Full sample 2 year interview weight.","Masked variance unit pseudo-PSU variable for variance estimation","Masked variance unit pseudo-stratum variable for variance estimation","A ratio of family income to poverty guidelines.","HELP AVAILABLE (Are you/Is SP) now taking prescribed medicine","{Have you/Has SP} ever been told by a doctor or other health professional that {you/s/he} had hypertension also called high blood pressure?","{Have you/Has SP} ever been told by a doctor or other health professional that {your/his/her} blood cholesterol level was high?","(Are you/Is SP) now following this advice to take prescribed medicine?","Direct HDL-Cholesterol (mg/dL)","Glycohemoglobin (%)","The next questions are about specific medical conditions. {Other than during pregnancy {have you/has SP}/{Have you/Has SP}} ever been told by a doctor or health professional that {you have/{he/she/SP} has} diabetes or sugar diabetes?","{Is SP/Are you} now taking insulin","{Is SP/Are you} now taking diabetic pills to lower {{his/her}/your} blood sugar? These are sometimes called oral agents or oral hypoglycemic agents.","{Have you/Has SP} ever been told by a doctor or other health professional that {you have/SP has} any of the following: prediabetes impaired fasting glucose impaired glucose tolerance borderline diabetes or that {your/her/his} blood sugar is higher than normal but not high enough to be called diabetes or sugar diabetes?","Body Mass Index (kg/m**2)","Total Cholesterol (mg/dL)"],["Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 20 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 6 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 1 YEARS - 150 YEARS","Both males and females 1 YEARS - 150 YEARS","Both males and females 1 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 2 YEARS - 150 YEARS","Both males and females 6 YEARS - 150 YEARS"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>VariableName<\/th>\n      <th>SASLabel<\/th>\n      <th>EnglishText<\/th>\n      <th>Target<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We will look at the relationship between the variable LBXTC (which is Total Cholesterol in mg/dL measured by a blood draw) and the age of the participant in years.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="session3_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And we can see that in this plot, over-plotting is a substantial issue here. You might also notice what seems like a lot of data at age 80, this is because any age over 80 was truncated to 80 to prevent reidentification of survey participants. In a complete analysis, this should probably be adjusted for in some way, but we will ignore it for now.</p>
<p>We can try some other methods, such as <code>hexbin</code> plotting and <code>smoothScatter</code> to get a better idea of the distribution of the data.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="session3_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we can see a few outliers - with extremely high serum cholesterol. We get a sense that the trend is not exactly a straight line, but rather a parabola, lower for the young and the old and a bit higher in the middle.</p>
<p>We fit a linear model first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">=</span> <span class="fu">lm</span>(d4<span class="sc">$</span>LBXTC <span class="sc">~</span> d4<span class="sc">$</span>RIDAGEYR)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = d4$LBXTC ~ d4$RIDAGEYR)

Residuals:
    Min      1Q  Median      3Q     Max 
-114.68  -27.95   -2.91   23.34  357.19 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 170.0140     1.4340  118.56   &lt;2e-16 ***
d4$RIDAGEYR   0.3708     0.0285   13.01   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 41.24 on 5689 degrees of freedom
  (372 observations deleted due to missingness)
Multiple R-squared:  0.02891,   Adjusted R-squared:  0.02874 
F-statistic: 169.4 on 1 and 5689 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lm1<span class="sc">$</span>fitted.values, lm1<span class="sc">$</span>residuals)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="do">##fit a loess curve</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>l2 <span class="ot">=</span> <span class="fu">loess</span>(lm1<span class="sc">$</span>residuals <span class="sc">~</span> lm1<span class="sc">$</span>fitted.values)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>pl <span class="ot">=</span> <span class="fu">predict</span>(l2, <span class="at">newdata=</span><span class="fu">sort</span>(lm1<span class="sc">$</span>fitted.values))</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="fu">sort</span>(lm1<span class="sc">$</span>fitted.values), <span class="at">y=</span>pl, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>, <span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="session3_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notice that both terms in the model are very significant, but that the multiple <span class="math inline">\(R^2\)</span> is only around 2%.<br>
So age, in years, is not explaining very much of the variation. But because we have such a large data set, the parameter estimates are found to be significantly different from zero.</p>
</section>
<section id="spline-models" class="level3">
<h3 data-anchor-id="spline-models">Spline Models</h3>
<p>When a linear model does not appear sufficient we can try other models. One choice is to use natural splines, which are very flexible. They create a “knotted” line, where at each knot the slope of the line can change. They are based on B-splines with the prevision that the model is linear outside the range of the data.</p>
<p>However, we have to decide the number of knots we want to use in the model. Based on the initial analysis, we chose to use df=7, which gives five internal knots when fitting the splines. You have almost 6,000 degrees of freedom here, so using up a few to get a more appropriate fit seems good.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"splines"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">=</span> <span class="fu">lm</span>(d4<span class="sc">$</span>LBXTC <span class="sc">~</span> <span class="fu">ns</span>(d4<span class="sc">$</span>RIDAGEYR, <span class="at">df=</span><span class="dv">7</span>))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = d4$LBXTC ~ ns(d4$RIDAGEYR, df = 7))

Residuals:
    Min      1Q  Median      3Q     Max 
-113.43  -26.32   -2.88   22.47  343.31 

Coefficients:
                         Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)               154.799      2.178  71.071  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)1   39.956      3.379  11.826  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)2   32.705      4.074   8.028 1.20e-15 ***
ns(d4$RIDAGEYR, df = 7)3   55.583      3.637  15.283  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)4   42.275      3.725  11.347  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)5   30.111      3.352   8.984  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)6   41.098      5.758   7.137 1.07e-12 ***
ns(d4$RIDAGEYR, df = 7)7   15.992      2.478   6.453 1.19e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 39.62 on 5683 degrees of freedom
  (372 observations deleted due to missingness)
Multiple R-squared:  0.1044,    Adjusted R-squared:  0.1033 
F-statistic: 94.65 on 7 and 5683 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>We can use an anova to compare the models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lm1, lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: d4$LBXTC ~ d4$RIDAGEYR
Model 2: d4$LBXTC ~ ns(d4$RIDAGEYR, df = 7)
  Res.Df     RSS Df Sum of Sq      F    Pr(&gt;F)    
1   5689 9674185                                  
2   5683 8922039  6    752146 79.848 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="analyzing-survey-data" class="level1">
<h1>Analyzing Survey Data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">#library(flextable)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#library(officer)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-1" class="level1">
<h1>Data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>all_nhanes <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/nhanes_survey.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 31034 Columns: 28
── Column specification
──────────────────────────────────────────────────────── Delimiter: "," chr
(11): RIAGENDR, RIDRETH1, DMDBORN, age.cat, LBXGH.cat, RIDAGEYR.cat, LBX... dbl
(14): ...1, SEQN, RIDAGEYR, INDFMPIR, SDMVPSU, SDMVSTRA, WTINT2YR, WTMEC... lgl
(3): OHXDECAY, OHXREST, dental.caries
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>nhanes_metadata <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../nhanes_metadata.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 24 Columns: 4
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (4): VariableName, SASLabel, EnglishText, Target

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(nhanes_metadata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-56fedff0af5d93b538e2" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-56fedff0af5d93b538e2">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],["RIDAGEYR","RIAGENDR","RIDRETH1","DMDBORN","INDFMPIR","SDMVPSU","SDMVSTRA","WTINT2YR","WTMEC2YR","OHXDECAY","OHXREST","LBXGLU","WTSAF2YR","LBXGH","BMXBMI","RIDAGEYR","RIAGENDR","RIDRETH1","DMDBORN2","INDFMPIR","SDMVPSU","SDMVSTRA","WTINT2YR","WTMEC2YR"],["Age at Screening Adjudicated - Recode","Gender","Race/Ethnicity - Recode","Country of Birth - Recode","Family PIR","Masked Variance Pseudo-PSU","Masked Variance Pseudo-Stratum","Full Sample 2 Year Interview Weight","Full Sample 2 Year MEC Exam Weight","Dental decay present","Dental restoration present","Fasting Glucose (mg/dL)","Fasting Subsample 2 Year MEC Weight","Glycohemoglobin (%)","Body Mass Index (kg/m**2)","Age at Screening Adjudicated - Recode","Gender","Race/Ethnicity - Recode","Country of Birth - Recode","Ratio of family income to poverty","Masked Variance Pseudo-PSU","Masked Variance Pseudo-Stratum","Full Sample 2 Year Interview Weight","Full Sample 2 Year MEC Exam Weight"],["Best age in years of the sample person at time of HH screening. Individuals 85 and over are topcoded at 85 years of age.","Gender of the sample person","Recode of reported race and ethnicity information.","In what country {were you/was SP} born?","Poverty income ratio (PIR) - a ratio of family income to poverty threshold","Masked Variance Unit Pseudo-PSU variable for variance estimation","Masked Variance Unit Pseudo-Stratum variable for variance estimation","Interviewed Sample Persons.","Both Interviewed and MEC Examined Sample Persons.","Presence of at least one tooth with dental decay","Presence of at least one tooth with a dental restoration","Fasting Glucose (mg/dL)","Fasting Subsample 2 Year MEC Weight","Glycohemoglobin (%)","Body Mass Index (kg/m**2)","Best age in years of the sample person at time of HH screening. Individuals 80 and over are topcoded at 80 years of age.","Gender of the sample person","Recode of reported race and ethnicity information.","In what country {were you/was SP} born?","A ratio of family income to poverty threshold","Masked Variance Unit Pseudo-PSU variable for variance estimation","Masked Variance Unit Pseudo-Stratum variable for variance estimation","Interviewed Sample Persons.","Both Interviewed and MEC Examined Sample Persons."],["Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 5 YEARS - 150 YEARS","Both males and females 5 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 2 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>VariableName<\/th>\n      <th>SASLabel<\/th>\n      <th>EnglishText<\/th>\n      <th>Target<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="preparing-survey-analysis" class="level1">
<h1>Preparing Survey Analysis</h1>
<section id="removing-na-weights" class="level2">
<h2 data-anchor-id="removing-na-weights">Removing NA weights</h2>
<p>We can’t have any missing values in the survey design variables.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remove all rows with <code>NA</code> for the main survey design variables; <code>WTMEC2YR</code>, <code>SDMVPSU</code>, and <code>SDMVSTRA</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>wt_nhanes <span class="ot">&lt;-</span> all_nhanes <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(WTMEC2YR, SDMVPSU, SDMVSTRA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="creating-combined-survey-weights" class="level2">
<h2 data-anchor-id="creating-combined-survey-weights">Creating combined survey weights</h2>
<p>Currently, our survey weights <code>WTSAF2YR</code> are for each 2 year cycle. We need to combine them to represent the full 6-year period we are investigating. Luckily NHANES has an <a href="https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx">official guide</a> for combining these weights. It turns out, all we need to do is divide all weights by 3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">##try de-tidying it to see if we can get the models to behave</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>wt_nhanes <span class="ot">&lt;-</span> wt_nhanes <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">WTMEC6YR =</span> WTMEC2YR <span class="sc">*</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>wt_nhanes<span class="ot">=</span><span class="fu">data.frame</span>(wt_nhanes)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a> wt_nhanes<span class="sc">$</span>diabetes <span class="ot">=</span> <span class="fu">factor</span>(wt_nhanes<span class="sc">$</span>diabetes, <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"nondiabetic"</span>,<span class="st">"prediabetic"</span>,<span class="st">"diabetic"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-the-survey-design-object" class="level2">
<h2 data-anchor-id="creating-the-survey-design-object">Creating the survey design object</h2>
<p>The CDC describes the survey as follows: <em>The sample design is a complex, multistage, clustered design using unequal probabilities of selection. Different groups (e.g., low-income persons, teens, older persons, and selected racial/ethnic populations) have been oversampled during specific survey cycles. Since 2011, the following groups have been oversampled: Hispanic persons; non-Hispanic black persons; non-Hispanic Asian persons; non-Hispanic white and other persons at or below 130 percent of poverty; and non-Hispanic white and other persons ages 80 and older. In 2015-16, the sampling design was revised, changing the cut-point for low-income oversampling from to at or below 185 percent of poverty. The estimation procedure used to produce national statistics for all NHANES involved inflation by the reciprocal of the probability of selection, adjustment for nonresponse, and post stratified ratio adjustment to population totals.</em></p>
<p>So to analyse this design we need to use some specialized survey analysis methods which are contained in the <code>survey</code> package written by Thomas Lumley.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>nhanes_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id     =</span> <span class="sc">~</span>SDMVPSU,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">strata  =</span> <span class="sc">~</span>SDMVSTRA,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">weights =</span> <span class="sc">~</span>WTMEC6YR,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nest    =</span> <span class="cn">TRUE</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">survey.lonely.psu =</span> <span class="st">"adjust"</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data    =</span> wt_nhanes)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhanes_design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stratified 1 - level Cluster Sampling design (with replacement)
With (93) clusters.
svydesign(id = ~SDMVPSU, strata = ~SDMVSTRA, weights = ~WTMEC6YR, 
    nest = TRUE, survey.lonely.psu = "adjust", data = wt_nhanes)
Probabilities:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
1.556e-05 8.077e-05 1.532e-04       Inf 3.014e-04       Inf 
Stratum Sizes: 
            44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60
obs        760 653 768 631 628 936 651 629 696 617 689 668 772 694 556 711 740
design.PSU   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2
actual.PSU   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2
            61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77
obs        852 788 694 689 731 716 797 714 530 541 560 561 267 258 803 785 823
design.PSU   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2
actual.PSU   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2
            78  79  80  81  82  83  84  85  86  87  88  89
obs        829 696 751 696 724 713 683 592 946 598 647 251
design.PSU   2   2   2   2   2   2   2   2   3   2   2   2
actual.PSU   2   2   2   2   2   2   2   2   3   2   2   2
Data variables:
 [1] "...1"          "SEQN"          "RIDAGEYR"      "RIAGENDR"     
 [5] "RIDRETH1"      "DMDBORN"       "INDFMPIR"      "SDMVPSU"      
 [9] "SDMVSTRA"      "WTINT2YR"      "WTMEC2YR"      "OHXDECAY"     
[13] "OHXREST"       "LBXGLU"        "WTSAF2YR"      "LBXGH"        
[17] "BMXBMI"        "Begin.Year"    "EndYear"       "age.cat"      
[21] "LBXGH.cat"     "RIDAGEYR.cat"  "LBXGLU.cat"    "BMXBMI.cat"   
[25] "INDFMPIR.cat"  "DMDBORN.cat"   "dental.caries" "diabetes"     
[29] "WTMEC6YR"     </code></pre>
</div>
</div>
<p>Now we can take our data subset from the survey design object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>ado_design <span class="ot">&lt;-</span> <span class="fu">subset</span>(nhanes_design, RIDAGEYR <span class="sc">&gt;=</span> <span class="dv">13</span> <span class="sc">&amp;</span> RIDAGEYR <span class="sc">&lt;=</span> <span class="dv">18</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(OHXDECAY))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Also make a tibble of this data to analyze</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>ado_data <span class="ot">&lt;-</span> wt_nhanes <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(RIDAGEYR <span class="sc">&gt;=</span> <span class="dv">13</span> <span class="sc">&amp;</span> RIDAGEYR <span class="sc">&lt;=</span> <span class="dv">18</span>) <span class="sc">%&gt;%</span> <span class="co"># Gets the 3660 nonedentulous adolescents</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(OHXDECAY)) <span class="sc">%&gt;%</span> <span class="co"># Gets the 3346 with non-NA dental carie variable</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(diabetes)) <span class="co"># Gets the 3046 with a diabetic status</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These correctly replicate the counts in table 1a</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>tab1 <span class="ot">=</span> <span class="fu">svytable</span>(<span class="sc">~</span>age.cat <span class="sc">+</span> dental.caries, ado_design)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>tab1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       dental.caries
age.cat   FALSE    TRUE
  13-15 5869985 6545245
  16-18 4858434 7112471</code></pre>
</div>
</div>
<p>And then we can also replicate the ethnicity distributions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytable</span>(<span class="sc">~</span>RIDRETH1, ado_design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RIDRETH1
              Mexican American             Non-Hispanic Black 
                       2764818                        3542439 
            Non-Hispanic White                 Other Hispanic 
                      15249583                        1334732 
Other Race - Including Multi-R 
                       1494563 </code></pre>
</div>
</div>
</section>
<section id="logistic-regression" class="level2">
<h2 data-anchor-id="logistic-regression">Logistic Regression</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: Unadjusted</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>logit1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(dental.caries<span class="sc">~</span> diabetes, <span class="at">family=</span>quasibinomial, <span class="at">design=</span>ado_design, <span class="at">na.action =</span> na.omit)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(logit1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept) diabetesprediabetic    diabetesdiabetic 
          1.2899734           0.9875545           2.9022173 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(logit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = dental.caries ~ diabetes, design = ado_design, 
    family = quasibinomial, na.action = na.omit)

Survey design:
subset(nhanes_design, RIDAGEYR &gt;= 13 &amp; RIDAGEYR &lt;= 18 &amp; !is.na(OHXDECAY))

Coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)          0.25462    0.06871   3.706 0.000575 ***
diabetesprediabetic -0.01252    0.14228  -0.088 0.930250    
diabetesdiabetic     1.06548    0.55644   1.915 0.061887 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for quasibinomial family taken to be 0.9922246)

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>A Wald test for <code>diabetes</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">regTermTest</span>(logit1, <span class="sc">~</span>diabetes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Wald test for diabetes
 in svyglm(formula = dental.caries ~ diabetes, design = ado_design, 
    family = quasibinomial, na.action = na.omit)
F =  1.835058  on  2  and  45  df: p= 0.17135 </code></pre>
</div>
</div>
</section>
</section>
<section id="exploring-packages" class="level1">
<h1>Exploring packages</h1>
<section id="predictive-modeling-with-tidymodels" class="level2">
<h2 data-anchor-id="predictive-modeling-with-tidymodels">Predictive Modeling with TidyModels</h2>
<p>This example comes from <a href="https://rviews.rstudio.com/2019/06/19/a-gentle-intro-to-tidymodels/">here</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ broom        1.0.5     ✔ rsample      1.2.0
✔ dials        1.2.0     ✔ tune         1.1.2
✔ infer        1.0.5     ✔ workflows    1.1.3
✔ modeldata    1.2.0     ✔ workflowsets 1.0.1
✔ parsnip      1.1.1     ✔ yardstick    1.2.0
✔ recipes      1.0.8     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ Matrix::expand()  masks tidyr::expand()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ Matrix::pack()    masks tidyr::pack()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
✖ Matrix::unpack()  masks tidyr::unpack()
✖ recipes::update() masks Matrix::update(), stats::update()
• Search for functions across packages at https://www.tidymodels.org/find/</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>iris_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(iris, <span class="at">prop =</span> <span class="fl">0.6</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>iris_split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Training/Testing/Total&gt;
&lt;90/60/150&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>iris_split <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">training</span>() <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 90
Columns: 5
$ Sepal.Length &lt;dbl&gt; 6.9, 4.6, 6.0, 5.1, 6.5, 5.8, 5.1, 6.7, 5.0, 6.3, 5.0, 6.…
$ Sepal.Width  &lt;dbl&gt; 3.2, 3.1, 2.2, 3.8, 3.0, 2.6, 2.5, 3.1, 2.3, 3.3, 3.4, 3.…
$ Petal.Length &lt;dbl&gt; 5.7, 1.5, 4.0, 1.5, 5.2, 4.0, 3.0, 4.7, 3.3, 4.7, 1.6, 5.…
$ Petal.Width  &lt;dbl&gt; 2.3, 0.2, 1.0, 0.3, 2.0, 1.2, 1.1, 1.5, 1.0, 1.6, 0.4, 2.…
$ Species      &lt;fct&gt; virginica, setosa, versicolor, setosa, virginica, versico…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>iris_recipe <span class="ot">&lt;-</span> <span class="fu">training</span>(iris_split) <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(Species <span class="sc">~</span>.) <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_predictors</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_predictors</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>iris_recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:   1
predictor: 4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 90 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Correlation filter on: Petal.Length | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering for: Sepal.Length, Sepal.Width, Petal.Width | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Scaling for: Sepal.Length, Sepal.Width, Petal.Width | Trained</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>iris_testing <span class="ot">&lt;-</span> iris_recipe <span class="sc">%&gt;%</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="fu">testing</span>(iris_split)) </span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(iris_testing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 4
$ Sepal.Length &lt;dbl&gt; -1.03988748, -1.37857218, -0.92699258, -1.60436198, -1.03…
$ Sepal.Width  &lt;dbl&gt; -0.16210326, 0.84405491, 0.84405491, -0.41364280, 0.08943…
$ Petal.Width  &lt;dbl&gt; -1.2702255, -1.1382160, -1.2702255, -1.2702255, -1.402235…
$ Species      &lt;fct&gt; setosa, setosa, setosa, setosa, setosa, setosa, setosa, s…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>iris_training <span class="ot">&lt;-</span> <span class="fu">juice</span>(iris_recipe)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(iris_training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 90
Columns: 4
$ Sepal.Length &lt;dbl&gt; 1.21801055, -1.37857218, 0.20195643, -0.81409768, 0.76643…
$ Sepal.Width  &lt;dbl&gt; 0.34097582, 0.08943628, -2.17441960, 1.85021308, -0.16210…
$ Petal.Width  &lt;dbl&gt; 1.50197570, -1.27022555, -0.21414888, -1.13821596, 1.1059…
$ Species      &lt;fct&gt; virginica, setosa, versicolor, setosa, virginica, versico…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>iris_rf <span class="ot">&lt;-</span>  <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">mode =</span> <span class="st">"classification"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"randomForest"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(Species <span class="sc">~</span> ., <span class="at">data =</span> iris_training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>iris_rf <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(iris_testing) <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(iris_testing) <span class="sc">%&gt;%</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 5
$ .pred_class  &lt;fct&gt; setosa, setosa, setosa, setosa, setosa, setosa, setosa, s…
$ Sepal.Length &lt;dbl&gt; -1.03988748, -1.37857218, -0.92699258, -1.60436198, -1.03…
$ Sepal.Width  &lt;dbl&gt; -0.16210326, 0.84405491, 0.84405491, -0.41364280, 0.08943…
$ Petal.Width  &lt;dbl&gt; -1.2702255, -1.1382160, -1.2702255, -1.2702255, -1.402235…
$ Species      &lt;fct&gt; setosa, setosa, setosa, setosa, setosa, setosa, setosa, s…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>iris_rf <span class="sc">%&gt;%</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(iris_testing) <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(iris_testing) <span class="sc">%&gt;%</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> Species, <span class="at">estimate =</span> .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy multiclass     0.9  
2 kap      multiclass     0.850</code></pre>
</div>
</div>
</section>
<section id="bayesian-statistics-with-stan-and-brms" class="level2">
<h2 data-anchor-id="bayesian-statistics-with-stan-and-brms">Bayesian Statistics with Stan and brms</h2>
<p>Adapted from <a href="https://m-clark.github.io/mixed-models-with-R/">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>pr <span class="ot">=</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">'b'</span>)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>bayesian_mixed <span class="ot">=</span> <span class="fu">brm</span>(</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  gpa <span class="sc">~</span> occasion <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> occasion <span class="sc">|</span> student), </span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data  =</span> gpa,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> pr,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(bayesian_mixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bayesian_mixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(bayesian_mixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(bayesian_mixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>